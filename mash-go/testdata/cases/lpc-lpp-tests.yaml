# Test Suite: LPC/LPP Use Case Tests
# Verifies EEBUS LPC/LPP compatibility behaviors
#
# LPC = Limitation of Power Consumption
# LPP = Limitation of Power Production
#
# Scenarios:
#   S00 (BASE): Limits + electrical + failsafe
#   S01 (MEASUREMENT): Measurement telemetry
#   S02 (OVERRIDE): Override tracking (DEC-049)

---
# ==========================================================================
# LPC BASE Scenario (S00)
# ==========================================================================

---
# TC-LPC-S00-001: SetLimit accepted, controlState transitions to LIMITED
id: TC-LPC-S00-001
name: SetLimit Accepted and Transitions to LIMITED
description: |
  Verifies SetLimit is accepted and controlState transitions to LIMITED.
  Enhanced response includes applied, controlState fields per DEC-049.

pics_requirements:
  - MASH.S.UC.LPC
  - MASH.S.UC.LPC.S00

preconditions:
  - session_established: true
  - device_accepts_limits: true

steps:
  - name: Send SetLimit command
    action: invoke
    params:
      endpoint: 1
      feature: EnergyControl
      command: SetLimit
      args:
        consumptionLimit: 5000000  # 5 kW
        cause: 0                   # GRID_EMERGENCY
    expect:
      invoke_success: true
      response_contains:
        - applied
        - controlState

  - name: Verify applied is true
    action: check_response
    params:
      field: applied
    expect:
      value: true

  - name: Verify controlState is LIMITED
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: controlState
    expect:
      read_success: true
      value: 2                     # LIMITED

postconditions:
  - limit_applied: true

timeout: "10s"
tags:
  - lpc
  - base
  - setlimit

---
# TC-LPC-S00-002: ClearLimit returns to CONTROLLED
id: TC-LPC-S00-002
name: ClearLimit Returns to CONTROLLED
description: |
  Verifies ClearLimit removes the active limit and returns
  controlState to CONTROLLED.

pics_requirements:
  - MASH.S.UC.LPC
  - MASH.S.UC.LPC.S00

preconditions:
  - session_established: true
  - limit_is_set: true

steps:
  - name: Verify device is LIMITED
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: controlState
    expect:
      read_success: true
      value: 2                     # LIMITED

  - name: Send ClearLimit command
    action: invoke
    params:
      endpoint: 1
      feature: EnergyControl
      command: ClearLimit
    expect:
      invoke_success: true

  - name: Verify controlState is CONTROLLED
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: controlState
    expect:
      read_success: true
      value: 1                     # CONTROLLED

postconditions:
  - limit_cleared: true

timeout: "10s"
tags:
  - lpc
  - base
  - clearlimit

---
# TC-LPC-S00-003: Failsafe activates after failsafeDuration expires
id: TC-LPC-S00-003
name: Failsafe Activates After Duration Expires
description: |
  Verifies that after failsafeDuration expires without heartbeat,
  device transitions to FAILSAFE state and applies failsafeConsumptionLimit.

pics_requirements:
  - MASH.S.UC.LPC
  - MASH.S.UC.LPC.S00

preconditions:
  - session_established: true
  - limit_is_set: true

steps:
  - name: Read failsafeDuration
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: failsafeDuration
    expect:
      read_success: true
      save_as: failsafe_duration

  - name: Wait for failsafe timeout (simulated)
    action: device_trigger
    params:
      trigger: simulate_failsafe_timeout

  - name: Verify controlState is FAILSAFE
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: controlState
    expect:
      read_success: true
      value: 3                     # FAILSAFE

  - name: Verify effectiveConsumptionLimit equals failsafe limit
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: effectiveConsumptionLimit
    expect:
      read_success: true
      save_as: effective_limit

postconditions:
  - failsafe_activated: true

timeout: "30s"
tags:
  - lpc
  - base
  - failsafe

---
# TC-LPC-S00-004: nominalMaxConsumption readable
id: TC-LPC-S00-004
name: Nominal Max Consumption Readable
description: |
  Verifies that nominalMaxConsumption is readable on Electrical
  feature, as required by LPC BASE.

pics_requirements:
  - MASH.S.UC.LPC
  - MASH.S.UC.LPC.S00

preconditions:
  - session_established: true

steps:
  - name: Read nominalMaxConsumption
    action: read
    params:
      endpoint: 1
      feature: Electrical
      attribute: nominalMaxConsumption
    expect:
      read_success: true
      value_gt: 0

postconditions:
  - nominal_max_readable: true

timeout: "10s"
tags:
  - lpc
  - base
  - electrical

---
# ==========================================================================
# LPC MEASUREMENT Scenario (S01)
# ==========================================================================

---
# TC-LPC-S01-001: Subscribe to Measurement, receive telemetry
id: TC-LPC-S01-001
name: Measurement Subscription Active
description: |
  Verifies that Measurement feature supports subscription and
  delivers telemetry updates during LPC operation.

pics_requirements:
  - MASH.S.UC.LPC
  - MASH.S.UC.LPC.S01

preconditions:
  - session_established: true

steps:
  - name: Subscribe to Measurement
    action: subscribe
    params:
      endpoint: 1
      feature: Measurement
    expect:
      subscribe_success: true

  - name: Verify acActivePower report received
    action: wait_report
    params:
      feature: Measurement
      attribute: acActivePower
      timeout: 5s
    expect:
      report_received: true
      value_is_not_null: true

postconditions:
  - measurement_subscription_active: true

timeout: "15s"
tags:
  - lpc
  - measurement
  - subscribe

---
# TC-LPC-S01-002: Power values reflect load changes
id: TC-LPC-S01-002
name: Power Values Reflect Load Changes
description: |
  Verifies that acActivePower changes when a limit is applied,
  reflecting the actual power consumption.

pics_requirements:
  - MASH.S.UC.LPC
  - MASH.S.UC.LPC.S00
  - MASH.S.UC.LPC.S01

preconditions:
  - session_established: true
  - measurement_subscription_active: true

steps:
  - name: Read initial power
    action: read
    params:
      endpoint: 1
      feature: Measurement
      attribute: acActivePower
    expect:
      read_success: true
      save_as: initial_power

  - name: Apply a restrictive limit
    action: invoke
    params:
      endpoint: 1
      feature: EnergyControl
      command: SetLimit
      args:
        consumptionLimit: 1000000  # 1 kW
        cause: 3                   # LOCAL_OPTIMIZATION

    expect:
      invoke_success: true

  - name: Wait for power report reflecting limit
    action: wait_report
    params:
      feature: Measurement
      attribute: acActivePower
      timeout: 10s
    expect:
      report_received: true

postconditions:
  - power_reflects_limit: true

timeout: "20s"
tags:
  - lpc
  - measurement
  - power

---
# ==========================================================================
# LPC OVERRIDE Scenario (S02)
# ==========================================================================

---
# TC-LPC-S02-001: Override attributes set during override
id: TC-LPC-S02-001
name: Override Reason and Direction Set During Override
description: |
  Verifies that when device enters OVERRIDE state, the
  overrideReason and overrideDirection attributes are set.

pics_requirements:
  - MASH.S.UC.LPC
  - MASH.S.UC.LPC.S02

preconditions:
  - session_established: true
  - device_supports_override: true

steps:
  - name: Trigger override (device-initiated)
    action: device_trigger
    params:
      trigger: enter_override
      reason: SELF_PROTECTION
      direction: consumption

  - name: Verify controlState is OVERRIDE
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: controlState
    expect:
      read_success: true
      value: 4                     # OVERRIDE

  - name: Verify overrideReason is SELF_PROTECTION
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: overrideReason
    expect:
      read_success: true
      value: 0                     # SELF_PROTECTION

  - name: Verify overrideDirection is CONSUMPTION
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: overrideDirection
    expect:
      read_success: true
      value: 0                     # CONSUMPTION

postconditions:
  - override_with_reason: true

timeout: "10s"
tags:
  - lpc
  - override
  - safety

---
# TC-LPC-S02-002: Override attributes cleared when override exits
id: TC-LPC-S02-002
name: Override Attributes Cleared on Exit
description: |
  Verifies that overrideReason and overrideDirection are
  cleared (null) when device exits OVERRIDE state.

pics_requirements:
  - MASH.S.UC.LPC
  - MASH.S.UC.LPC.S02

preconditions:
  - session_established: true
  - device_in_override: true

steps:
  - name: Exit override (device-initiated)
    action: device_trigger
    params:
      trigger: exit_override

  - name: Verify controlState is not OVERRIDE
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: controlState
    expect:
      read_success: true
      value_not_equal: 4           # Not OVERRIDE

  - name: Verify overrideReason is cleared
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: overrideReason
    expect:
      read_success: true
      value_is_null: true

  - name: Verify overrideDirection is cleared
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: overrideDirection
    expect:
      read_success: true
      value_is_null: true

postconditions:
  - override_cleared: true

timeout: "10s"
tags:
  - lpc
  - override
  - cleanup

---
# ==========================================================================
# LPP BASE Scenario (S00)
# ==========================================================================

---
# TC-LPP-S00-001: Production limit accepted
id: TC-LPP-S00-001
name: Production Limit Accepted
description: |
  Verifies that production limits work correctly for
  LPP (Limitation of Power Production) use case.

pics_requirements:
  - MASH.S.UC.LPP
  - MASH.S.UC.LPP.S00

preconditions:
  - session_established: true
  - device_supports_production: true

steps:
  - name: Send SetLimit with production limit
    action: invoke
    params:
      endpoint: 1
      feature: EnergyControl
      command: SetLimit
      args:
        productionLimit: 3000000   # 3 kW feed-in limit
        cause: 0                   # GRID_EMERGENCY
    expect:
      invoke_success: true
      response_contains:
        - applied
        - controlState

  - name: Verify applied is true
    action: check_response
    params:
      field: applied
    expect:
      value: true

  - name: Verify effectiveProductionLimit updated
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: effectiveProductionLimit
    expect:
      read_success: true
      value: 3000000

postconditions:
  - production_limit_set: true

timeout: "10s"
tags:
  - lpp
  - base
  - production

---
# TC-LPP-S00-002: ClearLimit restores autonomous production
id: TC-LPP-S00-002
name: ClearLimit Restores Autonomous Production
description: |
  Verifies that ClearLimit removes production limit and returns
  to CONTROLLED state.

pics_requirements:
  - MASH.S.UC.LPP
  - MASH.S.UC.LPP.S00

preconditions:
  - session_established: true
  - production_limit_set: true

steps:
  - name: Send ClearLimit
    action: invoke
    params:
      endpoint: 1
      feature: EnergyControl
      command: ClearLimit
    expect:
      invoke_success: true

  - name: Verify controlState returns to CONTROLLED
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: controlState
    expect:
      read_success: true
      value: 1                     # CONTROLLED

postconditions:
  - production_limit_cleared: true

timeout: "10s"
tags:
  - lpp
  - base
  - clearlimit

---
# TC-LPP-S00-003: nominalMaxProduction readable
id: TC-LPP-S00-003
name: Nominal Max Production Readable
description: |
  Verifies that nominalMaxProduction is readable on Electrical,
  as required by LPP BASE.

pics_requirements:
  - MASH.S.UC.LPP
  - MASH.S.UC.LPP.S00

preconditions:
  - session_established: true

steps:
  - name: Read nominalMaxProduction
    action: read
    params:
      endpoint: 1
      feature: Electrical
      attribute: nominalMaxProduction
    expect:
      read_success: true
      value_gt: 0

postconditions:
  - nominal_max_production_readable: true

timeout: "10s"
tags:
  - lpp
  - base
  - electrical

---
# ==========================================================================
# LPP MEASUREMENT Scenario (S01)
# ==========================================================================

---
# TC-LPP-S01-001: Subscribe to Measurement for production monitoring
id: TC-LPP-S01-001
name: Measurement Subscription for Production
description: |
  Verifies Measurement subscription delivers production telemetry.

pics_requirements:
  - MASH.S.UC.LPP
  - MASH.S.UC.LPP.S01

preconditions:
  - session_established: true

steps:
  - name: Subscribe to Measurement
    action: subscribe
    params:
      endpoint: 1
      feature: Measurement
    expect:
      subscribe_success: true

  - name: Verify power report received
    action: wait_report
    params:
      feature: Measurement
      attribute: acActivePower
      timeout: 5s
    expect:
      report_received: true

postconditions:
  - production_measurement_active: true

timeout: "15s"
tags:
  - lpp
  - measurement
  - subscribe

---
# ==========================================================================
# LPP OVERRIDE Scenario (S02)
# ==========================================================================

---
# TC-LPP-S02-001: Production override with reason
id: TC-LPP-S02-001
name: Production Override with Reason
description: |
  Verifies override attributes are set for production direction.

pics_requirements:
  - MASH.S.UC.LPP
  - MASH.S.UC.LPP.S02

preconditions:
  - session_established: true
  - device_supports_override: true

steps:
  - name: Trigger production override
    action: device_trigger
    params:
      trigger: enter_override
      reason: LEGAL_REQUIREMENT
      direction: production

  - name: Verify overrideDirection is PRODUCTION
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: overrideDirection
    expect:
      read_success: true
      value: 1                     # PRODUCTION

postconditions:
  - production_override_active: true

timeout: "10s"
tags:
  - lpp
  - override
  - production

---
# ==========================================================================
# Shared LPC/LPP Tests (existing, re-tagged)
# ==========================================================================

---
# TC-LPC-011: Negative Limit Rejected
id: TC-LPC-011
name: Negative Limit Rejected
description: |
  Verifies that negative limit values are rejected with
  INVALID_VALUE reason per LPC spec requirement.

pics_requirements:
  - MASH.S.UC.LPC
  - MASH.S.UC.LPC.S00

preconditions:
  - session_established: true
  - device_accepts_limits: true

steps:
  - name: Send SetLimit with negative value
    action: invoke
    params:
      endpoint: 1
      feature: EnergyControl
      command: SetLimit
      args:
        consumptionLimit: -1000    # Invalid negative
        cause: 0
    expect:
      invoke_success: true
      response_contains:
        - applied
        - rejectReason

  - name: Verify applied is false
    action: check_response
    params:
      field: applied
    expect:
      value: false

  - name: Verify rejectReason is INVALID_VALUE
    action: check_response
    params:
      field: rejectReason
    expect:
      value: 2                     # INVALID_VALUE

postconditions:
  - negative_limit_rejected: true

timeout: "10s"
tags:
  - lpc
  - base
  - validation
  - negative

---
# TC-LPC-012: Failsafe Duration Shared Between LPC/LPP
id: TC-LPC-012
name: Failsafe Duration Shared Between LPC/LPP
description: |
  Verifies that failsafeDuration is a single shared value
  (not separate for consumption/production).

pics_requirements:
  - MASH.S.UC.LPC
  - MASH.S.UC.LPC.S00

preconditions:
  - session_established: true

steps:
  - name: Read failsafeDuration
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: failsafeDuration
    expect:
      read_success: true
      value_gte: 7200              # >= 2 hours
      value_lte: 86400             # <= 24 hours

  - name: Verify single value (not per-direction)
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: failsafeDuration
    expect:
      read_success: true
      value_type: uint32           # Not a map

postconditions:
  - failsafe_duration_valid: true

timeout: "10s"
tags:
  - lpc
  - lpp
  - base
  - failsafe

---
# TC-LPC-013: SetLimit During Override Returns Device Override
id: TC-LPC-013
name: SetLimit During Override Rejected
description: |
  Verifies that SetLimit during OVERRIDE state returns
  applied=false with DEVICE_OVERRIDE reason.

pics_requirements:
  - MASH.S.UC.LPC
  - MASH.S.UC.LPC.S00
  - MASH.S.UC.LPC.S02

preconditions:
  - session_established: true
  - device_in_override: true

steps:
  - name: Attempt to set limit during override
    action: invoke
    params:
      endpoint: 1
      feature: EnergyControl
      command: SetLimit
      args:
        consumptionLimit: 5000000
        cause: 0
    expect:
      invoke_success: true
      response_contains:
        - applied
        - rejectReason

  - name: Verify applied is false
    action: check_response
    params:
      field: applied
    expect:
      value: false

  - name: Verify rejectReason is DEVICE_OVERRIDE
    action: check_response
    params:
      field: rejectReason
    expect:
      value: 3                     # DEVICE_OVERRIDE

postconditions:
  - limit_rejected_during_override: true

timeout: "10s"
tags:
  - lpc
  - base
  - override
  - rejection
