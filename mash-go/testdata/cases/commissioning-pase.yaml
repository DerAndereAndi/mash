# Test Case: PASE Commissioning
# Verifies password-authenticated session establishment using SPAKE2+

id: TC-COMM-001
name: PASE Commissioning Handshake
description: |
  Verifies that a controller can establish a secure session
  with a device using PASE (Password-Authenticated Session Establishment).

  This test performs the full SPAKE2+ handshake:
  1. Client sends PASERequest with public value (pA)
  2. Server responds with PASEResponse containing its public value (pB)
  3. Client sends PASEConfirm with its confirmation MAC
  4. Server sends PASEComplete with its confirmation MAC

  Upon success, both parties derive a shared 32-byte session key.

pics_requirements:
  - D.COMM.SC     # Device supports secure connection
  - D.COMM.PASE   # Device supports PASE commissioning

preconditions:
  - device_in_commissioning_mode: true
  - tls_connection_established: true

steps:
  - name: Perform PASE commissioning
    action: commission
    params:
      setup_code: "12345678"
    expect:
      session_established: true
      key_length: 32
      key_not_zero: true

postconditions:
  - session_active: true
  - commissioning_complete: true

timeout: "10s"
tags:
  - commissioning
  - PASE
  - security
  - SPAKE2+

---
# TC-COMM-005: Storage Full Returns STORAGE_ERROR
id: TC-COMM-005
name: Certificate Storage Full Returns STORAGE_ERROR
description: |
  Verifies that when a device cannot store the operational certificate
  (storage full -- e.g., max certs stored), the commissioning fails
  with STORAGE_ERROR. The device transitions from CERT_INSTALL back
  to ADVERTISING state.

pics_requirements:
  - D.COMM.PASE
  - D.CERT.EXCHANGE

preconditions:
  - device_in_commissioning_mode: true
  - device_storage_full: true

steps:
  - name: Attempt commissioning when storage is full
    action: commission
    params:
      setup_code: "12345678"
    expect:
      commission_success: false
      error: STORAGE_ERROR

  - name: Verify device returned to advertising
    action: browse_mdns
    params:
      service_type: "_mashc._udp"
    expect:
      device_found: true
      commissioning_mode: true

postconditions:
  - storage_full_rejected: true

timeout: "15s"
tags:
  - commissioning
  - PASE
  - storage
  - negative
