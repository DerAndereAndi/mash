# Test Suite: Multi-Zone Limit Tests
# Verifies multi-zone value resolution for limits and setpoints
#
# Key rules:
# - LIMITS: Most restrictive wins (smaller for consumption, closer to zero for production)
# - SETPOINTS: Highest priority zone wins (lower priority number = higher priority)
# - Zone priorities: GRID(1) > LOCAL(2)

---
# TC-ZONE-001: Single Zone Sets Limit
id: TC-ZONE-001
name: Single Zone Sets Limit
description: |
  Verifies that a single zone can set a consumption limit and the
  effective limit equals the set value.

pics_requirements:
  - MASH.S.ZONE
  - MASH.S.CTRL
  - MASH.S.CTRL.A0A          # acceptsLimits
  - MASH.S.CTRL.C01.Rsp      # SetLimit

preconditions:
  - session_established: true
  - zone_type: LOCAL
  - no_other_zones_connected: true

steps:
  - name: Set consumption limit
    action: invoke
    params:
      endpoint: 1
      feature: EnergyControl
      command: SetLimit
      args:
        consumptionLimit: 5000000  # 5 kW
    expect:
      invoke_success: true

  - name: Read effective consumption limit
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: effectiveConsumptionLimit
    expect:
      read_success: true
      value: 5000000           # 5 kW

  - name: Read my consumption limit
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: myConsumptionLimit
    expect:
      read_success: true
      value: 5000000           # Same as effective

postconditions:
  - effective_limit_set: true

timeout: "10s"
tags:
  - zone
  - limit
  - basic

---
# TC-ZONE-002: Two Zones - Lower Value Wins
id: TC-ZONE-002
name: Two Zones Lower Consumption Limit Wins
description: |
  Verifies that when two zones set consumption limits, the lower
  (more restrictive) value becomes the effective limit.

pics_requirements:
  - MASH.S.ZONE
  - MASH.S.ZONE.B_RESTRICT
  - MASH.S.CTRL

preconditions:
  - session_established: true
  - zone_type: LOCAL
  - second_zone_connected: GRID

steps:
  - name: Zone 1 (LOCAL) sets 8 kW limit
    action: invoke
    params:
      endpoint: 1
      feature: EnergyControl
      command: SetLimit
      args:
        consumptionLimit: 8000000  # 8 kW
    expect:
      invoke_success: true

  - name: Zone 2 (GRID) sets 5 kW limit
    action: invoke_as_zone
    params:
      zone: GRID
      endpoint: 1
      feature: EnergyControl
      command: SetLimit
      args:
        consumptionLimit: 5000000  # 5 kW (more restrictive)
    expect:
      invoke_success: true

  - name: Verify effective limit is 5 kW (lower wins)
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: effectiveConsumptionLimit
    expect:
      read_success: true
      value: 5000000           # Grid's limit wins

  - name: Verify LOCAL's own limit is still 8 kW
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: myConsumptionLimit
    expect:
      read_success: true
      value: 8000000           # Own limit unchanged

postconditions:
  - effective_limit: 5000000

timeout: "10s"
tags:
  - zone
  - multi-zone
  - limit
  - resolution

---
# TC-ZONE-003: Production Limit - Closer to Zero Wins
id: TC-ZONE-003
name: Production Limit Closer to Zero Wins
description: |
  Verifies that for production limits (negative values), the value
  closer to zero (more restrictive) wins.

pics_requirements:
  - MASH.S.ZONE
  - MASH.S.ZONE.B_RESTRICT
  - MASH.S.CTRL
  - MASH.S.ELEC.B_BIDIR      # Device is bidirectional

preconditions:
  - session_established: true
  - device_supports_production: true
  - two_zones_connected: true

steps:
  - name: Zone 1 sets production limit -10 kW
    action: invoke
    params:
      endpoint: 1
      feature: EnergyControl
      command: SetLimit
      args:
        productionLimit: -10000000  # -10 kW
    expect:
      invoke_success: true

  - name: Zone 2 sets production limit -3 kW
    action: invoke_as_zone
    params:
      zone: GRID
      endpoint: 1
      feature: EnergyControl
      command: SetLimit
      args:
        productionLimit: -3000000   # -3 kW (closer to zero = more restrictive)
    expect:
      invoke_success: true

  - name: Verify effective production limit is -3 kW
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: effectiveProductionLimit
    expect:
      read_success: true
      value: -3000000          # Closer to zero wins

postconditions:
  - effective_production_limit: -3000000

timeout: "10s"
tags:
  - zone
  - multi-zone
  - production
  - bidirectional

---
# TC-ZONE-004: Mixed Consumption/Production - Positive Takes Precedence
id: TC-ZONE-004
name: Mixed Signs - Positive Takes Precedence for Safety
description: |
  Verifies that when resolving limits with mixed signs, positive
  (consumption) values take precedence over negative (production)
  for safety reasons.

pics_requirements:
  - MASH.S.ZONE
  - MASH.S.ZONE.B_RESTRICT
  - MASH.S.CTRL
  - MASH.S.ELEC.B_BIDIR

preconditions:
  - session_established: true
  - device_is_bidirectional: true

steps:
  - name: Zone 1 sets positive (consumption) limit
    action: invoke
    params:
      endpoint: 1
      feature: EnergyControl
      command: SetLimit
      args:
        consumptionLimit: 1000000   # +1 kW consumption
    expect:
      invoke_success: true

  - name: Zone 2 sets production limit
    action: invoke_as_zone
    params:
      zone: GRID
      endpoint: 1
      feature: EnergyControl
      command: SetLimit
      args:
        productionLimit: -5000000   # -5 kW production
    expect:
      invoke_success: true

  - name: Verify consumption limit takes precedence
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: effectiveConsumptionLimit
    expect:
      read_success: true
      value: 1000000           # Consumption limit enforced

postconditions:
  - safety_precedence_applied: true

timeout: "10s"
tags:
  - zone
  - multi-zone
  - safety
  - mixed-sign

---
# TC-ZONE-005: Limit with Duration Expires
id: TC-ZONE-005
name: Limit with Duration Expires
description: |
  Verifies that a limit set with a duration parameter automatically
  expires after the specified duration.

pics_requirements:
  - MASH.S.ZONE
  - MASH.S.CTRL
  - MASH.S.CTRL.B_DURATION

preconditions:
  - session_established: true
  - no_existing_limits: true

steps:
  - name: Set limit with 5 second duration
    action: invoke
    params:
      endpoint: 1
      feature: EnergyControl
      command: SetLimit
      args:
        consumptionLimit: 3000000   # 3 kW
        duration: 5                  # 5 seconds
    expect:
      invoke_success: true

  - name: Verify limit is active
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: effectiveConsumptionLimit
    expect:
      read_success: true
      value: 3000000

  - name: Wait for duration to expire
    action: wait
    params:
      duration: "6s"

  - name: Verify limit has expired (returns to unlimited)
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: effectiveConsumptionLimit
    expect:
      read_success: true
      value_is_null: true      # Or unlimited indicator

postconditions:
  - limit_expired: true

timeout: "15s"
tags:
  - zone
  - duration
  - expiry

---
# TC-ZONE-006: Higher Priority Zone's Setpoint Wins
id: TC-ZONE-006
name: Higher Priority Zone Setpoint Wins
description: |
  Verifies that for setpoints, the highest priority zone's value wins.
  GRID (priority 1) > LOCAL (priority 2).

pics_requirements:
  - MASH.S.ZONE
  - MASH.S.ZONE.B_PRIORITY
  - MASH.S.CTRL
  - MASH.S.CTRL.A0C          # acceptsSetpoints

preconditions:
  - session_established: true
  - two_zones_connected: true
  - accepts_setpoints: true

steps:
  - name: LOCAL (priority 2) sets setpoint
    action: invoke
    params:
      endpoint: 1
      feature: EnergyControl
      command: SetSetpoint
      args:
        consumptionSetpoint: 7000000  # 7 kW
    expect:
      invoke_success: true

  - name: GRID (priority 1) sets setpoint
    action: invoke_as_zone
    params:
      zone: GRID
      endpoint: 1
      feature: EnergyControl
      command: SetSetpoint
      args:
        consumptionSetpoint: 4000000  # 4 kW
    expect:
      invoke_success: true

  - name: Verify effective setpoint is GRID's (4 kW)
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: effectiveConsumptionSetpoint
    expect:
      read_success: true
      value: 4000000           # Higher priority wins

postconditions:
  - priority_resolution_correct: true

timeout: "10s"
tags:
  - zone
  - multi-zone
  - setpoint
  - priority

---
# TC-ZONE-007: Zone Disconnect Affects Resolution
id: TC-ZONE-007
name: Zone Disconnect Affects Limit Resolution
description: |
  Verifies that when a zone disconnects, its values are no longer
  considered in the effective limit calculation.

pics_requirements:
  - MASH.S.ZONE
  - MASH.S.ZONE.CONNECT
  - MASH.S.CTRL

preconditions:
  - session_established: true
  - two_zones_connected: true

steps:
  - name: Zone 1 (LOCAL) sets 8 kW limit
    action: invoke
    params:
      endpoint: 1
      feature: EnergyControl
      command: SetLimit
      args:
        consumptionLimit: 8000000
    expect:
      invoke_success: true

  - name: Zone 2 (GRID) sets 3 kW limit
    action: invoke_as_zone
    params:
      zone: GRID
      endpoint: 1
      feature: EnergyControl
      command: SetLimit
      args:
        consumptionLimit: 3000000
    expect:
      invoke_success: true

  - name: Verify effective limit is 3 kW
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: effectiveConsumptionLimit
    expect:
      value: 3000000

  - name: Disconnect Zone 2 (GRID)
    action: disconnect_zone
    params:
      zone: GRID

  - name: Wait for disconnect to be detected
    action: wait
    params:
      duration: "2s"

  - name: Verify effective limit is now 8 kW (LOCAL's)
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: effectiveConsumptionLimit
    expect:
      read_success: true
      value: 8000000           # Only remaining zone's limit

postconditions:
  - disconnected_zone_excluded: true

timeout: "15s"
tags:
  - zone
  - disconnect
  - resolution

---
# TC-ZONE-008: Per-Phase Limit Resolution
id: TC-ZONE-008
name: Per-Phase Current Limit Resolution
description: |
  Verifies that per-phase current limits from multiple zones are
  resolved correctly (most restrictive per phase).

pics_requirements:
  - MASH.S.ZONE
  - MASH.S.ZONE.B_RESTRICT
  - MASH.S.CTRL
  - MASH.S.CTRL.F09          # ASYMMETRIC
  - MASH.S.CTRL.C05.Rsp      # SetCurrentLimits

preconditions:
  - session_established: true
  - device_supports_asymmetric: true
  - two_zones_connected: true

steps:
  - name: Zone 1 sets per-phase limits
    action: invoke
    params:
      endpoint: 1
      feature: EnergyControl
      command: SetCurrentLimits
      args:
        phases:
          A: 16000             # 16A
          B: 20000             # 20A
          C: 16000             # 16A
        direction: consumption
    expect:
      invoke_success: true

  - name: Zone 2 sets different per-phase limits
    action: invoke_as_zone
    params:
      zone: GRID
      endpoint: 1
      feature: EnergyControl
      command: SetCurrentLimits
      args:
        phases:
          A: 20000             # 20A (less restrictive on A)
          B: 10000             # 10A (more restrictive on B)
          C: 12000             # 12A (more restrictive on C)
        direction: consumption
    expect:
      invoke_success: true

  - name: Verify effective limits (most restrictive per phase)
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: effectiveCurrentLimitsConsumption
    expect:
      read_success: true
      value:
        A: 16000               # Zone 1's limit (lower)
        B: 10000               # Zone 2's limit (lower)
        C: 12000               # Zone 2's limit (lower)

postconditions:
  - per_phase_resolution_correct: true

timeout: "10s"
tags:
  - zone
  - multi-zone
  - asymmetric
  - per-phase

---
# TC-ZONE-009: Zone Reconnect Restores Values
id: TC-ZONE-009
name: Zone Reconnect Restores Previous Values
description: |
  Verifies that when a zone reconnects, its previously set values
  are still in effect (until duration expires).

pics_requirements:
  - MASH.S.ZONE
  - MASH.S.ZONE.CONNECT
  - MASH.S.ZONE.LAST_SEEN
  - MASH.S.CTRL

preconditions:
  - session_established: true
  - zone_has_set_values: true

steps:
  - name: Set a limit with long duration
    action: invoke
    params:
      endpoint: 1
      feature: EnergyControl
      command: SetLimit
      args:
        consumptionLimit: 6000000
        duration: 3600         # 1 hour
    expect:
      invoke_success: true

  - name: Verify limit is active
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: myConsumptionLimit
    expect:
      value: 6000000

  - name: Disconnect temporarily
    action: disconnect
    params:
      graceful: true

  - name: Wait briefly
    action: wait
    params:
      duration: "2s"

  - name: Reconnect
    action: connect
    params:
      insecure: true

  - name: Verify limit is still active
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: myConsumptionLimit
    expect:
      read_success: true
      value: 6000000           # Still active

postconditions:
  - values_persisted: true

timeout: "15s"
tags:
  - zone
  - reconnect
  - persistence

---
# TC-ZONE-010: Maximum 5 Zones Enforcement
id: TC-ZONE-010
name: Maximum 5 Zones Enforcement
description: |
  Verifies that a device enforces the maximum of 5 zones and
  rejects additional zone connections.

pics_requirements:
  - MASH.S.ZONE
  - MASH.S.ZONE.MAX

preconditions:
  - device_has_4_zones: true   # 4 zones already connected

steps:
  - name: Connect 5th zone (should succeed)
    action: connect_as_zone
    params:
      zone_type: LOCAL
      zone_id: "zone-5"
    expect:
      connection_success: true

  - name: Verify 5 zones connected
    action: read
    params:
      endpoint: 0
      feature: DeviceInfo
      attribute: connectedZones
    expect:
      read_success: true
      zone_count: 5

  - name: Attempt to connect 6th zone (should fail)
    action: connect_as_zone
    params:
      zone_type: LOCAL
      zone_id: "zone-6"
    expect:
      connection_success: false
      error: MAX_ZONES_EXCEEDED

postconditions:
  - max_zones_enforced: true

timeout: "15s"
tags:
  - zone
  - capacity
  - limit

---
# TC-ZONE-011: All Zones Clear Limit Returns to Unlimited
id: TC-ZONE-011
name: All Zones Clear Limit Returns to Unlimited
description: |
  Verifies that when all zones clear their limits, the effective
  limit returns to unlimited (null).

pics_requirements:
  - MASH.S.ZONE
  - MASH.S.CTRL
  - MASH.S.CTRL.C02.Rsp      # ClearLimit

preconditions:
  - session_established: true
  - two_zones_with_limits: true

steps:
  - name: Verify limits are set
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: effectiveConsumptionLimit
    expect:
      read_success: true
      value_is_not_null: true

  - name: Zone 1 clears its limit
    action: invoke
    params:
      endpoint: 1
      feature: EnergyControl
      command: ClearLimit
      args:
        direction: consumption
    expect:
      invoke_success: true

  - name: Zone 2 clears its limit
    action: invoke_as_zone
    params:
      zone: GRID
      endpoint: 1
      feature: EnergyControl
      command: ClearLimit
      args:
        direction: consumption
    expect:
      invoke_success: true

  - name: Verify effective limit is unlimited (null)
    action: read
    params:
      endpoint: 1
      feature: EnergyControl
      attribute: effectiveConsumptionLimit
    expect:
      read_success: true
      value_is_null: true      # No limit = unlimited

postconditions:
  - all_limits_cleared: true

timeout: "10s"
tags:
  - zone
  - clear
  - unlimited
