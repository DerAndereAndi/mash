# Test Case: Operational Device Discovery
# Verifies that commissioned devices advertise via mDNS for reconnection

id: TC-DISC-002
name: Operational mDNS Discovery
description: |
  Verifies that after commissioning, a device transitions from commissionable
  discovery (_mashc._udp) to operational discovery (_mash._tcp).

  The operational advertisement allows controllers to rediscover devices
  for reconnection after network disruptions.

pics_requirements:
  - D.COMM.SC     # Device supports secure connection
  - D.DISC.MDNS   # Device supports mDNS discovery
  - D.DISC.OP     # Device supports operational discovery

preconditions:
  - device_commissioned: true
  - device_in_zone: true

steps:
  - name: Verify commissionable service stopped
    action: browse_mdns
    params:
      service_type: "_mashc._udp"
      timeout_ms: 3000
    expect:
      device_found: false

  - name: Discover operational service
    action: browse_mdns
    params:
      service_type: "_mash._tcp"
      timeout_ms: 5000
    expect:
      device_found: true
      service_has_txt_records: true

  - name: Verify operational TXT records
    action: verify_txt_records
    params:
      required_keys:
        - "ZI"  # Zone ID (16 hex chars)
        - "DI"  # Device ID (16 hex chars)
      optional_keys:
        - "VP"  # Vendor:Product
        - "FW"  # Firmware version
        - "EP"  # Endpoint count
        - "FM"  # Feature map
    expect:
      txt_valid: true
      zone_id_length: 16
      device_id_length: 16
      zone_id_hex_valid: true
      device_id_hex_valid: true

  - name: Verify zone ID matches commissioned zone
    action: verify_zone_binding
    expect:
      zone_id_matches: true

  - name: Simulate disconnect
    action: disconnect_zone
    expect:
      connection_closed: true

  - name: Verify operational service persists after disconnect
    action: browse_mdns
    params:
      service_type: "_mash._tcp"
      timeout_ms: 3000
    expect:
      device_found: true

postconditions:
  - operational_advertising_active: true
  - device_reconnectable: true

timeout: "15s"
tags:
  - base-protocol
  - discovery
  - mDNS
  - operational
  - reconnection
