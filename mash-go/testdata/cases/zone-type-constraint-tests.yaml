# Test Suite: Zone Type Constraint Tests
# Verifies DEC-043: One Zone Per Zone Type Constraint
#
# Key concepts:
# - Device can belong to at most one zone per zone type
# - Max 1 GRID zone (regulatory/external)
# - Max 1 LOCAL zone (local energy management)
# - Total: 2 zones maximum per device
# - Same zone type commissioning is rejected with ZONE_TYPE_EXISTS

---
# TC-ZTYPE-001: First Zone Commission Success
id: TC-ZTYPE-001
name: First Zone Commission Success
description: |
  An uncommissioned device accepts commissioning from the first
  controller. The zone is added successfully regardless of zone type.

  This verifies the basic case: an uncommissioned device can be
  commissioned by any zone type.

pics_requirements:
  - MASH.S.ZONE.MAX
  - MASH.S.ZONE.GRID
  - MASH.S.ZONE.LOCAL
  - D.COMM.PASE

preconditions:
  - device_uncommissioned: true
  - commissioning_window_open: true

steps:
  - name: Commission with GRID zone type
    action: commission
    params:
      setup_code: "{{ setup_code }}"
      zone_type: "GRID"
      zone_id: "grid-zone-001"
    expect:
      commission_success: true
      session_established: true

  - name: Verify zone was added
    action: list_zones
    expect:
      zone_count: 1
      zones:
        - zone_id: "grid-zone-001"
          zone_type: "GRID"

postconditions:
  - device_has_one_zone: true
  - zone_type_is_grid: true

timeout: "15s"
tags:
  - base-protocol
  - zone
  - commissioning
  - first-zone
  - basic

---
# TC-ZTYPE-002: Second Zone Different Type Success
id: TC-ZTYPE-002
name: Second Zone Different Type Success
description: |
  A device that has one zone (GRID) can be commissioned by another
  controller with a different zone type (LOCAL). This results in the
  device having 2 zones - the maximum allowed.

  This verifies that different zone types can coexist on the same device.

pics_requirements:
  - MASH.S.ZONE.MAX
  - MASH.S.ZONE.GRID
  - MASH.S.ZONE.LOCAL
  - D.COMM.PASE

preconditions:
  - device_has_grid_zone: true
  - zone_count: 1
  - commissioning_window_open: true

steps:
  - name: Verify device has GRID zone
    action: list_zones
    expect:
      zone_count: 1
      zones:
        - zone_type: "GRID"

  - name: Commission with LOCAL zone type
    action: commission
    params:
      setup_code: "{{ setup_code }}"
      zone_type: "LOCAL"
      zone_id: "local-zone-001"
    expect:
      commission_success: true
      session_established: true

  - name: Verify both zones exist
    action: list_zones
    expect:
      zone_count: 2
      zones:
        - zone_type: "GRID"
        - zone_type: "LOCAL"

postconditions:
  - device_has_two_zones: true
  - device_at_max_zones: true

timeout: "15s"
tags:
  - base-protocol
  - zone
  - commissioning
  - multi-zone
  - different-types

---
# TC-ZTYPE-003: Same Zone Type Rejected
id: TC-ZTYPE-003
name: Same Zone Type Commissioning Rejected
description: |
  A device that already has a GRID zone rejects commissioning from
  another GRID controller. The error code is ZONE_TYPE_EXISTS (10).

  This enforces the one-zone-per-type constraint to prevent:
  - Multiple SMGWs controlling the same device
  - Multiple EMSs with conflicting optimization strategies

pics_requirements:
  - MASH.S.ZONE.MAX
  - MASH.S.ZONE.GRID

preconditions:
  - device_has_grid_zone: true
  - zone_count: 1
  - commissioning_window_open: true

steps:
  - name: Verify device has GRID zone
    action: list_zones
    expect:
      zones:
        - zone_type: "GRID"

  - name: Attempt to commission another GRID zone
    action: commission
    params:
      setup_code: "{{ setup_code }}"
      zone_type: "GRID"
      zone_id: "grid-zone-002"
    expect:
      commission_success: false
      error_code: 10                   # ZONE_TYPE_EXISTS
      error_message_contains: "zone type already exists"

  - name: Verify zone count unchanged
    action: list_zones
    expect:
      zone_count: 1                    # Still just 1 zone

postconditions:
  - zone_count_unchanged: true
  - same_type_rejected: true

timeout: "15s"
tags:
  - base-protocol
  - zone
  - commissioning
  - constraint
  - negative
  - same-type

---
# TC-ZTYPE-004: Max Zones Not Advertising Commissioning
id: TC-ZTYPE-004
name: Max Zones Not Advertising Commissioning
description: |
  When a device has all zone slots filled (GRID + LOCAL = 2 non-TEST
  zones), it does not advertise _mash-comm._tcp. The device is at capacity
  and should not accept new commissioning attempts.

  TEST zones do not count toward zone limits -- they are a transparent
  control channel for test-specific communication.

pics_requirements:
  - MASH.S.ZONE.MAX
  - MASH.S.ZONE.GRID
  - MASH.S.ZONE.LOCAL

preconditions:
  - two_zones_connected: true

steps:
  - name: Verify device is NOT advertising commissioning
    action: verify_mdns_not_advertising
    params:
      service_type: "_mash-comm._tcp"
      timeout_ms: 3000
    expect:
      not_advertising: true

postconditions:
  - device_at_max_zones: true
  - not_advertising_commissioning: true

timeout: "15s"
tags:
  - base-protocol
  - zone
  - capacity
  - max-zones
  - commissioning

---
# TC-ZTYPE-005: Zone Removal Auto-Enters Commissioning
id: TC-ZTYPE-005
name: Zone Removal Auto-Enters Commissioning
description: |
  When a zone is removed from a device at max capacity, the device
  auto-enters commissioning mode and advertises _mash-comm._tcp (DEC-059).

  Starts at max capacity (GRID + LOCAL), LOCAL zone self-removes.
  The device now has an available zone slot and must become
  commissionable again.

pics_requirements:
  - MASH.S.ZONE.MAX
  - MASH.S.ZONE.REMOVE
  - MASH.S.ZONE.GRID
  - MASH.S.ZONE.LOCAL

preconditions:
  - two_zones_connected: true

steps:
  # LOCAL zone self-removes (only self-removal is allowed per protocol).
  - name: Remove LOCAL zone
    action: invoke_as_zone
    params:
      zone: LOCAL
      endpoint: 0
      feature: DeviceInfo
      command: RemoveZone
      args:
        zoneId: "{{ local_zone_id }}"
    expect:
      invoke_success: true

  # Device went from 2 -> 1 non-TEST zones, has an available slot.
  - name: Verify device is advertising commissioning
    action: verify_mdns_advertising
    params:
      service_type: "_mash-comm._tcp"
      timeout_ms: 10000
    expect:
      advertising: true

postconditions:
  - zone_removed: true
  - commissioning_window_open: true

timeout: "20s"
tags:
  - base-protocol
  - zone
  - removal
  - commissioning
  - auto-entry

---
# TC-ZTYPE-006: LOCAL Zone Type Duplicate Rejected
id: TC-ZTYPE-006
name: LOCAL Zone Type Duplicate Rejected
description: |
  A device that already has a LOCAL zone rejects commissioning from
  another LOCAL controller. This is the symmetric case of TC-ZTYPE-003
  for LOCAL zone types.

  This prevents multiple EMSs from controlling the same device with
  potentially conflicting optimization strategies.

pics_requirements:
  - MASH.S.ZONE.MAX
  - MASH.S.ZONE.LOCAL

preconditions:
  - device_has_local_zone: true
  - zone_count: 1
  - commissioning_window_open: true

steps:
  - name: Verify device has LOCAL zone
    action: list_zones
    expect:
      zones:
        - zone_type: "LOCAL"

  - name: Attempt to commission another LOCAL zone
    action: commission
    params:
      setup_code: "{{ setup_code }}"
      zone_type: "LOCAL"
      zone_id: "local-zone-002"
    expect:
      commission_success: false
      error_code: 10                   # ZONE_TYPE_EXISTS
      error_message_contains: "zone type already exists"

  - name: Verify zone count unchanged
    action: list_zones
    expect:
      zone_count: 1

postconditions:
  - zone_count_unchanged: true
  - same_type_rejected: true

timeout: "15s"
tags:
  - base-protocol
  - zone
  - commissioning
  - constraint
  - negative
  - local

---
# TC-ZTYPE-007: Zone Type Replacement After Removal
id: TC-ZTYPE-007
name: Zone Type Replacement After Removal
description: |
  A device that has a zone removed can be commissioned by a new
  controller of the same zone type. This enables zone replacement
  scenarios (e.g., replacing an SMGW with a new SMGW).

pics_requirements:
  - MASH.S.ZONE.MAX
  - MASH.S.ZONE.GRID
  - MASH.S.ZONE.REMOVE

preconditions:
  - device_has_grid_zone: true
  - zone_count: 1

steps:
  - name: Remove existing GRID zone
    action: invoke
    params:
      endpoint: 0
      feature: DeviceInfo
      command: RemoveZone
      args:
        zoneId: "{{ grid_zone_id }}"
    expect:
      invoke_success: true
      response:
        removed: true

  - name: Wait for cleanup
    action: wait
    params:
      duration: "2s"

  - name: Commission new GRID zone
    action: commission
    params:
      setup_code: "{{ setup_code }}"
      zone_type: "GRID"
      zone_id: "new-grid-zone"
    expect:
      commission_success: true
      session_established: true

  - name: Verify new GRID zone is active
    action: list_zones
    expect:
      zone_count: 1
      zones:
        - zone_id: "new-grid-zone"
          zone_type: "GRID"

postconditions:
  - old_zone_removed: true
  - new_zone_added: true
  - zone_type_replaced: true

timeout: "20s"
tags:
  - base-protocol
  - zone
  - replacement
  - commissioning
  - removal
