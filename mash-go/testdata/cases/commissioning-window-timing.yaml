# Test Suite: Commissioning Window Timing Tests
# Verifies DEC-048: Commissioning Window Duration Alignment
#
# These tests use setCommissioningWindowDuration (TestControl command) to set
# short window durations, enabling fast mechanism-based verification (~30-40s)
# rather than waiting for the full 15-minute production default.
#
# DEC-048 constants: Default 15m, Min 3m, Max 3h.

---
# TC-COMM-WINDOW-001: Commissioning Window Expires After Set Duration
id: TC-COMM-WINDOW-001
name: Commissioning Window Expires After Set Duration
description: |
  Verifies that the commissioning window expires after the configured duration.
  Uses setCommissioningWindowDuration to set a short (20s) window, then verifies
  the device stops advertising as commissionable after the window expires.

pics_requirements:
  - MASH.S.COMM                        # Device supports commissioning

preconditions:
  - device_commissioned: true

steps:
  - name: Set short commissioning window (20s)
    action: set_commissioning_window_duration
    params:
      duration_seconds: 20
    expect:
      duration_set: true

  - name: Enter commissioning mode
    action: enter_commissioning_mode
    expect:
      commissioning_mode: true

  - name: Verify commissionable advertisement
    action: verify_mdns_advertising
    params:
      service_type: "_mashc._udp"
    expect:
      advertising: true

  - name: Wait 15 seconds (window still open)
    action: wait
    params:
      duration_seconds: 15
    note: Window should still be open (20s total)

  - name: Verify still advertising at 15 seconds
    action: verify_mdns_advertising
    params:
      service_type: "_mashc._udp"
    expect:
      advertising: true

  - name: Wait 10 more seconds (total ~25s, past 20s window)
    action: wait
    params:
      duration_seconds: 10
    note: Window should now be expired

  - name: Verify no longer advertising
    action: verify_mdns_not_advertising
    params:
      service_type: "_mashc._udp"
    expect:
      not_advertising: true

timeout: "60s"
tags:
  - base-protocol
  - commissioning
  - timing
  - DEC-048

---
# TC-COMM-WINDOW-002: Pairing Request Re-triggers Expired Window
id: TC-COMM-WINDOW-002
name: Pairing Request Re-triggers Expired Window
description: |
  Verifies that a pairing request (_mashp._udp) re-opens the commissioning
  window after it has expired. Uses a short window (15s) to keep total test
  time under 40 seconds.

pics_requirements:
  - MASH.S.COMM                        # Device supports commissioning
  - MASH.S.COMM.PAIRING_REQUEST        # Device responds to pairing requests

preconditions:
  - device_commissioned: true

steps:
  - name: Set short commissioning window (15s)
    action: set_commissioning_window_duration
    params:
      duration_seconds: 15
    expect:
      duration_set: true

  - name: Enter commissioning mode
    action: enter_commissioning_mode
    expect:
      commissioning_mode: true

  - name: Wait for window to expire (20s > 15s window)
    action: wait
    params:
      duration_seconds: 20
    note: Wait past the 15-second window

  - name: Verify window closed
    action: verify_mdns_not_advertising
    params:
      service_type: "_mashc._udp"
    expect:
      not_advertising: true

  - name: Send pairing request with matching discriminator
    action: announce_pairing_request
    params:
      service_type: "_mashp._udp"
      discriminator: "{{ device_discriminator }}"
      controller_id: "{{ controller_id }}"
    expect:
      announcement_sent: true

  - name: Wait for device to detect pairing request
    action: wait
    params:
      duration_seconds: 5

  - name: Verify window re-opened
    action: verify_mdns_advertising
    params:
      service_type: "_mashc._udp"
      timeout_ms: 5000
    expect:
      advertising: true

timeout: "60s"
tags:
  - base-protocol
  - commissioning
  - pairing-request
  - timing
  - DEC-048

---
# TC-COMM-WINDOW-003: Minimum Window Duration Enforcement
id: TC-COMM-WINDOW-003
name: Minimum Window Duration Enforcement
description: |
  Verifies device enforces minimum 3-minute commissioning window.
  Attempts to set shorter duration should be rejected or clamped to minimum.

  This prevents misconfiguration that would make commissioning impractical.

pics_requirements:
  - MASH.S.COMM                            # Device supports commissioning
  - MASH.S.COMM.WINDOW_CONFIGURABLE        # Device supports configurable duration
  - MASH.S.COMM.WINDOW_MIN: 180            # Minimum is 3 minutes (180 seconds)

preconditions:
  - device_idle: true

steps:
  - name: Attempt to set 1-minute window (below minimum)
    action: set_commissioning_window_duration
    params:
      duration_seconds: 60
    expect:
      # Implementation should either reject or clamp to minimum
      result: "clamped_or_rejected"

  - name: Verify effective duration is at least 3 minutes
    action: get_commissioning_window_duration
    expect:
      duration_seconds_min: 180

postconditions:
  - minimum_enforced: true

timeout: "1m"
tags:
  - base-protocol
  - commissioning
  - timing
  - validation
  - DEC-048

---
# TC-COMM-WINDOW-004: Maximum Window Duration Enforcement
id: TC-COMM-WINDOW-004
name: Maximum Window Duration Enforcement
description: |
  Verifies device enforces maximum 3-hour commissioning window.
  Attempts to set longer duration should be rejected or clamped to maximum.

  MASH allows up to 3 hours (vs Matter's 15 min max) for professional
  installer scenarios, but beyond that is excessive.

pics_requirements:
  - MASH.S.COMM                            # Device supports commissioning
  - MASH.S.COMM.WINDOW_CONFIGURABLE        # Device supports configurable duration
  - MASH.S.COMM.WINDOW_MAX: 10800          # Maximum is 3 hours (10800 seconds)

preconditions:
  - device_idle: true

steps:
  - name: Attempt to set 4-hour window (above maximum)
    action: set_commissioning_window_duration
    params:
      duration_seconds: 14400
    expect:
      # Implementation should either reject or clamp to maximum
      result: "clamped_or_rejected"

  - name: Verify effective duration is at most 3 hours
    action: get_commissioning_window_duration
    expect:
      duration_seconds_max: 10800

postconditions:
  - maximum_enforced: true

timeout: "1m"
tags:
  - base-protocol
  - commissioning
  - timing
  - validation
  - DEC-048

---
# TC-COMM-WINDOW-005: Window Closes on Successful Commission
id: TC-COMM-WINDOW-005
name: Window Closes on Successful Commission
description: |
  Verifies that commissioning window closes immediately after successful
  commissioning, regardless of remaining time.

  This is a security requirement - once commissioned, the device should
  not remain in commissionable state.

pics_requirements:
  - MASH.S.COMM                        # Device supports commissioning

preconditions:
  - device_uncommissioned: true

steps:
  - name: Enter commissioning mode
    action: enter_commissioning_mode
    expect:
      commissioning_mode: true

  - name: Verify commissionable advertisement
    action: verify_mdns_advertising
    params:
      service_type: "_mashc._udp"
    expect:
      advertising: true

  - name: Commission device successfully
    action: commission
    params:
      setup_code: "{{ setup_code }}"
      zone_type: "LOCAL"
    expect:
      commission_success: true

  - name: Verify window closed immediately
    action: verify_mdns_not_advertising
    params:
      service_type: "_mashc._udp"
    expect:
      not_advertising: true

postconditions:
  - device_commissioned: true
  - commissioning_window_closed: true

timeout: "5m"
tags:
  - base-protocol
  - commissioning
  - timing
  - security
  - DEC-048
