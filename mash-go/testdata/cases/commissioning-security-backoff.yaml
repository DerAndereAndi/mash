# Test Cases: PASE Backoff (DEC-047)
# Security hardening for PASE attempt tracking with exponential backoff

---
id: TC-SEC-BACKOFF-001
name: PASE Backoff Tier Enforcement
description: |
  Verifies device implements exponential backoff on failed PASE attempts.
  Attempts 1-3 should have no delay, attempt 4+ should have increasing delays.

pics_requirements:
  - MASH.S.COMM.BACKOFF_ENABLED

preconditions:
  - device_in_commissioning_mode: true

steps:
  - name: Attempts 1-3 (no backoff expected)
    action: pase_attempts
    params:
      count: 3
      setup_code: "00000000"
    expect:
      all_responses_immediate: true
      max_delay_ms: 100

  - name: Attempt 4 (tier 2 backoff)
    action: pase_attempt_timed
    params:
      setup_code: "00000000"
    expect:
      response_delay_ms_min: "${MASH.S.COMM.BACKOFF_TIER2}"

  - name: Attempts 5-6 (tier 2 continues)
    action: pase_attempts
    params:
      count: 2
      setup_code: "00000000"
    expect:
      min_delay_ms: "${MASH.S.COMM.BACKOFF_TIER2}"

  - name: Attempt 7 (tier 3 backoff)
    action: pase_attempt_timed
    params:
      setup_code: "00000000"
    expect:
      response_delay_ms_min: "${MASH.S.COMM.BACKOFF_TIER3}"

postconditions:
  - backoff_enforced: true

timeout: "120s"
tags:
  - base-protocol
  - security
  - commissioning
  - backoff
  - DEC-047

---
id: TC-SEC-BACKOFF-002
name: Backoff Reset on Window Close
description: |
  Verifies backoff counter resets when commissioning window closes.
  After window closes and reopens, first attempt should have no delay.

pics_requirements:
  - MASH.S.COMM.BACKOFF_ENABLED

preconditions:
  - device_idle: true

steps:
  - name: Enter commissioning mode
    action: enter_commissioning_mode

  - name: Accumulate failed attempts to trigger backoff
    action: pase_attempts
    timeout: "60s"
    params:
      count: 10
      setup_code: "00000000"

  - name: Exit commissioning mode
    action: exit_commissioning_mode

  - name: Re-enter commissioning mode
    action: enter_commissioning_mode

  - name: First attempt after reset (should be immediate)
    action: pase_attempt_timed
    params:
      setup_code: "00000000"
    expect:
      response_delay_ms_max: 100

postconditions:
  - backoff_counter_reset: true

timeout: "180s"
tags:
  - base-protocol
  - security
  - commissioning
  - backoff
  - DEC-047

---
id: TC-SEC-BACKOFF-003
name: Backoff Reset on Success
description: |
  Verifies backoff counter resets on successful commissioning.
  After successful commissioning, next commissioning window should start fresh.

pics_requirements:
  - MASH.S.COMM.BACKOFF_ENABLED
  - MASH.S.ZONE.MAX

preconditions:
  - device_has_available_zone_slot: true

steps:
  - name: Enter commissioning mode
    action: enter_commissioning_mode

  - name: Accumulate failed attempts
    action: pase_attempts
    timeout: "30s"
    params:
      count: 5
      setup_code: "00000000"

  - name: Successful commissioning
    action: commission
    params:
      setup_code: "{{ setup_code }}"
    expect:
      success: true

  - name: Re-enter commissioning mode (for second zone)
    action: enter_commissioning_mode

  - name: First attempt in new window (should be immediate)
    action: pase_attempt_timed
    params:
      setup_code: "00000000"
    expect:
      response_delay_ms_max: 100

postconditions:
  - backoff_counter_reset: true
  - first_zone_commissioned: true

timeout: "120s"
tags:
  - base-protocol
  - security
  - commissioning
  - backoff
  - DEC-047
