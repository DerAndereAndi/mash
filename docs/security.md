# MASH Security Model

> Certificates, commissioning, zones, and trust

**Status:** Draft
**Last Updated:** 2025-01-25

---

## Related Documents

| Document | Description |
|----------|-------------|
| [Protocol Overview](protocol-overview.md) | Vision, architecture, device model |
| [Transport](transport.md) | TLS configuration |
| [Discovery](discovery.md) | mDNS, QR codes |
| [Matter Comparison](matter-comparison.md) | PKI model comparison with Matter |
| [Device Attestation](device-attestation-considerations.md) | Why MASH doesn't include attestation |

---

## 1. Trust Model

### 1.1 Binary Trust

MASH uses binary trust: **paired or not paired**.

| EEBUS | MASH |
|-------|------|
| Trust levels 0-100 | Binary: paired/unpaired |
| Complex trust negotiation | Pairing grants full access |
| "Appropriate client" undefined | Clear zone membership |

### 1.2 Trust Hierarchy

Priority determines who can override whom, not who is "more trusted":

```
GRID (priority 1) > LOCAL (priority 2)
```

All paired controllers are fully trusted within their zone. Priority only affects conflict resolution.

---

## 2. Certificate Hierarchy

```
┌─────────────────────────────────────────────────────────┐
│  Zone CA (controller-generated, 20yr)                   │
│    ├── Controller Operational Cert (1yr)                │
│    └── Device Operational Certs (1yr each)              │
└─────────────────────────────────────────────────────────┘
```

**Note:** Controller and device operational certificates are **siblings** in the hierarchy.
Both are signed by the Zone CA. They are independently issued and independently renewed.
Renewal of one does not affect the validity of the other.

**Note:** MASH does not include device attestation certificates. See
[Device Attestation Considerations](device-attestation-considerations.md) for the rationale.

### 2.1 Operational Certificate

- **Purpose:** Proves zone membership, enables encrypted communication
- **Issuer:** Zone CA (controller)
- **Validity:** 1 year (auto-renewed)
- **Issued:** During commissioning
- **Revocation:** RemoveZone command

### 2.2 Zone CA

- **Purpose:** Root of trust for a zone
- **Generated by:** Zone owner (EMS, SMGW)
- **Validity:** 20 years (matches device lifetime, avoids mass re-commissioning)
- **Stored:** Securely on zone owner

### 2.3 Controller Operational Certificate

- **Purpose:** Proves controller identity to devices during operational TLS
- **Issuer:** Zone CA (self-issued by controller)
- **Validity:** 1 year (auto-renewed)
- **Generated:** Automatically when Zone CA is created
- **Key Usage:** DigitalSignature, KeyEncipherment
- **Extended Key Usage:** ClientAuth, ServerAuth

**Why separate from Zone CA?** The Zone CA is a CA certificate used for signing.
The controller operational certificate is an end-entity certificate used for TLS authentication.
This follows Matter's design where controllers have their own Node Operational Certificate (NOC)
separate from their CA signing capability.

---

## 3. Certificate Lifecycle

| Certificate | Validity | Renewal | Revocation |
|-------------|----------|---------|------------|
| Device Operational | 1 year | Auto by controller | RemoveZone command |
| Controller Operational | 1 year | Auto (self-renewal) | Zone CA rotation |
| Zone CA | 20 years | Manual | Zone dissolution |

### 3.1 Device Operational Certificate Renewal

1. Controller tracks certificate expiry for each device
2. 30 days before expiry, controller initiates renewal
3. Device generates new key pair and CSR
4. Controller signs new certificate with Zone CA
5. Device installs new certificate atomically
6. TLS session continues (uses session keys, not certificates)

### 3.2 Controller Operational Certificate Renewal

1. Controller monitors its own certificate expiry
2. 30 days before expiry, controller self-renews
3. Controller generates new key pair
4. Controller signs new certificate with Zone CA
5. New certificate replaces old one
6. Existing device connections unaffected (use session keys)

**Note:** Controller cert renewal does NOT require device cert renewal.
Both certificates are independently signed by the Zone CA.

### 3.3 Certificate Revocation

No CRL or OCSP. Revocation is immediate:

1. Controller sends RemoveZone command
2. Device deletes operational certificate for that zone
3. Connection is closed
4. Device will not accept connections from that zone

---

## 4. Commissioning (PASE-like)

### 4.1 Setup Code

- **Format:** 8 decimal digits (00000000-99999999)
- **Entropy:** ~27 bits
- **Delivery:** QR code, printed label, or manual entry

### 4.2 QR Code Content

```
MASH:<version>:<discriminator>:<setupcode>:<vendorid>:<productid>
Example: MASH:1:1234:12345678:0x1234:0x5678
```

| Field | Description |
|-------|-------------|
| version | Protocol version (1) |
| discriminator | 12-bit device discriminator for mDNS filtering |
| setupcode | 8-digit setup code |
| vendorid | Vendor ID (hex) |
| productid | Product ID (hex) |

### 4.3 Commissioning Flow

```
Controller                         Device
     │                               │
     │◄── mDNS: _mash._tcp ──────────┤  Advertising
     │                               │
     │── TCP Connect ───────────────►│
     │                               │
     │◄── SPAKE2+ (setup code) ─────►│  From QR code (8 digits)
     │                               │
     │── Request CSR ───────────────►│
     │◄── CSR with new key pair ─────┤
     │                               │
     │── Install Operational Cert ──►│  Signed by Zone CA
     │                               │
     │── Commissioning Complete ────►│
     │                               │
```

### 4.4 SPAKE2+ Protocol

SPAKE2+ provides password-authenticated key exchange:

1. Both sides derive keys from setup code
2. Exchange commitments
3. Verify without revealing setup code
4. Establish shared secret for session encryption

**Why SPAKE2+:**
- Resistant to offline dictionary attacks
- Setup code never transmitted
- Forward secrecy
- Same as Matter (proven, audited)

---

## 5. Operational Sessions (CASE-like)

After commissioning, devices use mutual TLS authentication:

```
Controller                         Device
     │                               │
     │── TLS with Operational Cert ─►│  Mutual authentication
     │◄── Verify same Zone ──────────┤
     │                               │
     │◄── Encrypted Session ────────►│  Read/Write/Subscribe/Invoke
```

### 5.1 Session Establishment

1. Controller initiates TLS connection
2. Both sides present operational certificates
3. Both verify certificates are signed by same Zone CA
4. Session is established
5. All subsequent communication is encrypted

### 5.2 Session Security Properties

- **Confidentiality:** TLS 1.3 encryption
- **Integrity:** TLS MAC
- **Authentication:** Mutual certificate verification
- **Forward secrecy:** Ephemeral key exchange

---

## 6. Multi-Zone Model

Devices can belong to multiple zones simultaneously.

### 6.1 Zone Concept

```
┌─────────────────────────────────────────────────────────────┐
│                      Device (EVSE)                           │
├─────────────────────────────────────────────────────────────┤
│  Zone 1: GRID                                                │
│    └── Operational Cert from SMGW                           │
│    └── Priority 1 for LoadControl                           │
│                                                              │
│  Zone 2: LOCAL                                               │
│    └── Operational Cert from EMS                            │
│    └── Priority 2 for LoadControl                           │
│                                                              │
│  Max Zones: 5                                                │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 Zone Types

| Zone Type | Priority | Typical Owner |
|-----------|----------|---------------|
| GRID | 1 (highest) | DSO, SMGW, utility |
| LOCAL | 2 | Residential/building EMS |

### 6.3 Priority Resolution

- Priority is per-feature, not global
- Higher priority can override lower priority settings
- Lower priority is notified of override
- Device tracks which zone set current value
- User physical override (button on device) always possible

**Example:**
```
SMGW sets consumptionLimit = 6000W (priority 1)
EMS sets consumptionLimit = 8000W (priority 3)
→ Effective limit: 6000W (SMGW wins)
→ EMS is notified that its limit was overridden
```

---

## 7. Zone Roles

```
┌────────────────────────────────────────────────────────────┐
│  Zone Owner    │ Has Zone CA, issues certs   │ EMS, SMGW  │
│  Zone Admin    │ Can commission devices      │ Phone App  │
│  Zone Member   │ Normal participant          │ Devices    │
└────────────────────────────────────────────────────────────┘
```

### 7.1 Zone Owner

- Generates and holds Zone CA private key
- Issues operational certificates
- Can add/remove zone members
- Typically: EMS, SMGW

### 7.2 Zone Admin

- Can commission devices on behalf of zone owner
- Does NOT hold Zone CA (forwards CSRs to owner)
- Can be added/removed by owner
- Typically: Phone apps, installer tools

**Key principle:** Apps are admins, NOT owners. Losing phone doesn't break anything.

### 7.3 Zone Member

- Has operational certificate from zone
- Can communicate with other zone members
- Typically: Devices (EVSE, inverter, etc.)

---

## 8. Admin Authorization Flow

### 8.1 Adding an Admin (Phone App)

```
User             Phone App           EMS Web UI
 │                   │                   │
 │── "Add admin" ────┼──────────────────►│
 │◄── Temp QR (5min) ┼───────────────────┤
 │── Scan QR ───────►│── SPAKE2+ ───────►│
 │◄── "Confirm?" ────┼───────────────────┤
 │── Yes ────────────┼──────────────────►│
 │                   │◄── Admin token ───┤
```

### 8.2 App Commissioning Device (as Admin)

```
Phone App              EMS                 Device
    │                   │                    │
    │── SPAKE2+ ───────┼───────────────────►│  (app has setup code)
    │◄─────────────────┼───────── CSR ──────┤
    │── Forward CSR ──►│                    │
    │◄── Signed cert ──┤                    │
    │── Install cert ──┼───────────────────►│  (device in EMS zone)
```

---

## 9. Delegated Commissioning

For grid operator zones (SMGW), commissioning is delegated through backend:

```
User           Phone App       DSO Backend       SMGW          Device
 │                 │               │               │              │
 │── Scan QR ─────►│── Upload ────►│── Forward ───►│              │
 │                 │               │               │── SPAKE2+ ──►│
 │                 │               │               │◄── Accept ───┤
```

**Flow:**
1. User scans device QR code with app
2. App uploads setup info to DSO backend
3. DSO backend forwards to appropriate SMGW
4. SMGW commissions device directly
5. User is notified of success

---

## 10. Comparison with EEBUS SHIP Security

| Aspect | EEBUS SHIP | MASH Security |
|--------|------------|---------------|
| Trust model | Levels 0-100 | Binary (paired/unpaired) |
| Certificate source | Device self-signs | Zone CA issues |
| Pairing | Complex state machine | SPAKE2+ (like Matter) |
| Multi-controller | Undefined | Explicit zones with priority |
| Revocation | Delete from access list | RemoveZone command |
| Session establishment | SHIP handshake | Mutual TLS |

**Key improvements:**
- Clear trust model (no ambiguous trust levels)
- Controller issues certificates (clean revocation)
- SPAKE2+ is proven and audited
- Multi-zone with explicit priority resolution
