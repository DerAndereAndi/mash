# MASH Security Model

> Certificates, commissioning, zones, and trust

**Status:** Draft
**Last Updated:** 2026-01-29

---

## Related Documents

| Document | Description |
|----------|-------------|
| [Protocol Overview](protocol-overview.md) | Vision, architecture, device model |
| [Multi-Zone](multi-zone.md) | Zone types, roles, priority resolution |
| [Transport](transport.md) | TLS configuration |
| [Discovery](discovery.md) | mDNS, QR codes |
| [Matter Comparison](matter-comparison.md) | PKI model comparison with Matter |
| [Device Attestation](device-attestation-considerations.md) | Why MASH doesn't include attestation |

---

## 1. Trust Model

### 1.1 Binary Trust

MASH uses binary trust: **paired or not paired**.

| EEBUS | MASH |
|-------|------|
| Trust levels 0-100 | Binary: paired/unpaired |
| Complex trust negotiation | Pairing grants full access |
| "Appropriate client" undefined | Clear zone membership |

### 1.2 Trust Hierarchy

Priority determines who can override whom, not who is "more trusted":

```
GRID (priority 1) > LOCAL (priority 2)
```

All paired controllers are fully trusted within their zone. Priority only affects conflict resolution.

---

## 2. Certificate Hierarchy

```
┌─────────────────────────────────────────────────────────┐
│  Zone CA (controller-generated, 20yr)                   │
│    ├── Controller Operational Cert (1yr)                │
│    └── Device Operational Certs (1yr each)              │
└─────────────────────────────────────────────────────────┘
```

**Note:** Controller and device operational certificates are **siblings** in the hierarchy.
Both are signed by the Zone CA. They are independently issued and independently renewed.
Renewal of one does not affect the validity of the other.

**Note:** MASH does not include device attestation certificates. See
[Device Attestation Considerations](device-attestation-considerations.md) for the rationale.

### 2.1 Operational Certificate

- **Purpose:** Proves zone membership, enables encrypted communication
- **Issuer:** Zone CA (controller)
- **Validity:** 1 year (auto-renewed)
- **Issued:** During commissioning
- **Revocation:** RemoveZone command

### 2.2 Zone CA

- **Purpose:** Root of trust for a zone
- **Generated by:** Zone owner (EMS, SMGW)
- **Validity:** 20 years (matches device lifetime, avoids mass re-commissioning)
- **Stored:** Securely on zone owner

### 2.3 Controller Operational Certificate

- **Purpose:** Proves controller identity to devices during operational TLS
- **Issuer:** Zone CA (self-issued by controller)
- **Validity:** 1 year (auto-renewed)
- **Generated:** Automatically when Zone CA is created
- **Key Usage:** DigitalSignature, KeyEncipherment
- **Extended Key Usage:** ClientAuth, ServerAuth

**Why separate from Zone CA?** The Zone CA is a CA certificate used for signing.
The controller operational certificate is an end-entity certificate used for TLS authentication.
This follows Matter's design where controllers have their own Node Operational Certificate (NOC)
separate from their CA signing capability.

---

## 3. Certificate Lifecycle

| Certificate | Validity | Renewal | Revocation |
|-------------|----------|---------|------------|
| Device Operational | 1 year | Auto by controller | RemoveZone command |
| Controller Operational | 1 year | Auto (self-renewal) | Zone CA rotation |
| Zone CA | 20 years | Manual | Zone dissolution |

### 3.1 Device Operational Certificate Renewal

1. Controller tracks certificate expiry for each device
2. 30 days before expiry, controller initiates renewal
3. Device generates new key pair and CSR
4. Controller signs new certificate with Zone CA
5. Device installs new certificate atomically
6. TLS session continues (uses session keys, not certificates)

### 3.2 Controller Operational Certificate Renewal

1. Controller monitors its own certificate expiry
2. 30 days before expiry, controller self-renews
3. Controller generates new key pair
4. Controller signs new certificate with Zone CA
5. New certificate replaces old one
6. Existing device connections unaffected (use session keys)

**Note:** Controller cert renewal does NOT require device cert renewal.
Both certificates are independently signed by the Zone CA.

### 3.3 Certificate Revocation

No CRL or OCSP. Revocation is immediate:

1. Controller sends RemoveZone command
2. Device deletes operational certificate for that zone
3. Connection is closed
4. Device will not accept connections from that zone

---

## 4. Commissioning (PASE-like)

### 4.1 Setup Code

- **Format:** 8 decimal digits (00000000-99999999)
- **Entropy:** ~27 bits
- **Delivery:** QR code, printed label, or manual entry

### 4.2 QR Code Content

```
MASH:<version>:<discriminator>:<setupcode>:<vendorid>:<productid>
Example: MASH:1:1234:12345678:0x1234:0x5678
```

| Field | Description |
|-------|-------------|
| version | Protocol version (1) |
| discriminator | 12-bit device discriminator for mDNS filtering |
| setupcode | 8-digit setup code |
| vendorid | Vendor ID (hex) |
| productid | Product ID (hex) |

### 4.3 Commissioning Flow

```
Controller                         Device
     │                               │
     │◄── mDNS: _mash._tcp ──────────┤  Advertising
     │                               │
     │── TCP Connect ───────────────►│
     │                               │
     │◄── SPAKE2+ (setup code) ─────►│  From QR code (8 digits)
     │                               │
     │── Request CSR ───────────────►│
     │◄── CSR with new key pair ─────┤
     │                               │
     │── Install Operational Cert ──►│  Signed by Zone CA
     │                               │
     │── Commissioning Complete ────►│
     │                               │
```

### 4.4 SPAKE2+ Protocol

SPAKE2+ provides password-authenticated key exchange:

1. Both sides derive keys from setup code
2. Exchange commitments
3. Verify without revealing setup code
4. Establish shared secret for session encryption

**Why SPAKE2+:**
- Resistant to offline dictionary attacks
- Setup code never transmitted
- Forward secrecy
- Same as Matter (proven, audited)

---

## 5. Operational Sessions (CASE-like)

After commissioning, devices use mutual TLS authentication:

```
Controller                         Device
     │                               │
     │── TLS with Operational Cert ─►│  Mutual authentication
     │◄── Verify same Zone ──────────┤
     │                               │
     │◄── Encrypted Session ────────►│  Read/Write/Subscribe/Invoke
```

### 5.1 Session Establishment

1. Controller initiates TLS connection
2. Both sides present operational certificates
3. Both verify certificates are signed by same Zone CA
4. Session is established
5. All subsequent communication is encrypted

### 5.2 Session Security Properties

- **Confidentiality:** TLS 1.3 encryption
- **Integrity:** TLS MAC
- **Authentication:** Mutual certificate verification
- **Forward secrecy:** Ephemeral key exchange

---

## 6. Multi-Zone Model

Devices can belong to multiple zones simultaneously.

### 6.1 Zone Concept

```
┌─────────────────────────────────────────────────────────────┐
│                      Device (EVSE)                           │
├─────────────────────────────────────────────────────────────┤
│  Zone 1: GRID                                                │
│    └── Operational Cert from SMGW                           │
│    └── Priority 1 for LoadControl                           │
│                                                              │
│  Zone 2: LOCAL                                               │
│    └── Operational Cert from EMS                            │
│    └── Priority 2 for LoadControl                           │
│                                                              │
│  Max Zones: 5                                                │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 Zone Types

| Zone Type | Priority | Typical Owner |
|-----------|----------|---------------|
| GRID | 1 (highest) | DSO, SMGW, utility |
| LOCAL | 2 | Residential/building EMS |

### 6.3 Priority Resolution

- Priority is per-feature, not global
- Higher priority can override lower priority settings
- Lower priority is notified of override
- Device tracks which zone set current value
- User physical override (button on device) always possible

**Example:**
```
SMGW sets consumptionLimit = 6000W (priority 1)
EMS sets consumptionLimit = 8000W (priority 3)
→ Effective limit: 6000W (SMGW wins)
→ EMS is notified that its limit was overridden
```

---

## 7. Zone Roles

```
┌────────────────────────────────────────────────────────────┐
│  Zone Owner    │ Has Zone CA, issues certs   │ EMS, SMGW  │
│  Zone Admin    │ Can commission devices      │ Phone App  │
│  Zone Member   │ Normal participant          │ Devices    │
└────────────────────────────────────────────────────────────┘
```

### 7.1 Zone Owner

- Generates and holds Zone CA private key
- Issues operational certificates
- Can add/remove zone members
- Typically: EMS, SMGW

### 7.2 Zone Admin

- Can commission devices on behalf of zone owner
- Does NOT hold Zone CA (forwards CSRs to owner)
- Can be added/removed by owner
- Typically: Phone apps, installer tools

**Key principle:** Apps are admins, NOT owners. Losing phone doesn't break anything.

### 7.3 Zone Member

- Has operational certificate from zone
- Can communicate with other zone members
- Typically: Devices (EVSE, inverter, etc.)

---

## 8. Admin Authorization Flow

### 8.1 Adding an Admin (Phone App)

```
User             Phone App           EMS Web UI
 │                   │                   │
 │── "Add admin" ────┼──────────────────►│
 │◄── Temp QR (5min) ┼───────────────────┤
 │── Scan QR ───────►│── SPAKE2+ ───────►│
 │◄── "Confirm?" ────┼───────────────────┤
 │── Yes ────────────┼──────────────────►│
 │                   │◄── Admin token ───┤
```

### 8.2 App Commissioning Device (as Admin)

```
Phone App              EMS                 Device
    │                   │                    │
    │── SPAKE2+ ───────┼───────────────────►│  (app has setup code)
    │◄─────────────────┼───────── CSR ──────┤
    │── Forward CSR ──►│                    │
    │◄── Signed cert ──┤                    │
    │── Install cert ──┼───────────────────►│  (device in EMS zone)
```

---

## 9. Delegated Commissioning

For grid operator zones (SMGW), commissioning is delegated through backend:

```
User           Phone App       DSO Backend       SMGW          Device
 │                 │               │               │              │
 │── Scan QR ─────►│── Upload ────►│── Forward ───►│              │
 │                 │               │               │── SPAKE2+ ──►│
 │                 │               │               │◄── Accept ───┤
```

**Flow:**
1. User scans device QR code with app
2. App uploads setup info to DSO backend
3. DSO backend forwards to appropriate SMGW
4. SMGW commissions device directly
5. User is notified of success

---

## 10. Comparison with EEBUS SHIP Security

| Aspect | EEBUS SHIP | MASH Security |
|--------|------------|---------------|
| Trust model | Levels 0-100 | Binary (paired/unpaired) |
| Certificate source | Device self-signs | Zone CA issues |
| Pairing | Complex state machine | SPAKE2+ (like Matter) |
| Multi-controller | Undefined | Explicit zones with priority |
| Revocation | Delete from access list | RemoveZone command |
| Session establishment | SHIP handshake | Mutual TLS |

**Key improvements:**
- Clear trust model (no ambiguous trust levels)
- Controller issues certificates (clean revocation)
- SPAKE2+ is proven and audited
- Multi-zone with explicit priority resolution

---

## 11. Commissioning Security Hardening (DEC-047)

### 11.1 Connection Model

The connection model is derived from zone capacity to ensure predictable resource usage:

**Connection Capacity:**

| Connection Type | Maximum | Description |
|-----------------|---------|-------------|
| Operational | max_zones | One persistent connection per paired zone |
| Commissioning | 1 | Single concurrent commissioning attempt |
| **Total** | max_zones + 1 | Maximum simultaneous connections |

**Example for typical device (max_zones = 2):**
- Up to 2 operational connections (Zone 1 GRID + Zone 2 LOCAL)
- Up to 1 commissioning connection (when zone slot available)
- Total maximum: 3 connections

**Commissioning Availability:**

| Zone Slots Used | Commissioning Allowed | Rationale |
|-----------------|----------------------|-----------|
| 0 | Yes | Device uncommissioned |
| 1 (of 2) | Yes | One slot available |
| 2 (of 2) | **No** | No slot for new zone |

**Device Behavior:**
1. Device MUST track operational connections per zone (0 or 1 each)
2. Device MUST track commissioning connection state (0 or 1)
3. When all zone slots filled:
   - Device MUST NOT advertise as commissionable (CM=0 or no _mash-comm._tcp)
   - Device MUST send `CommissioningError(DEVICE_BUSY)` after PASERequest (see Section 11.8)
4. When commissioning already in progress:
   - Device MUST send `CommissioningError(DEVICE_BUSY)` with RetryAfter hint (see Section 11.8)
5. Operational connections from existing zones MUST be allowed during commissioning
6. Device SHOULD implement connection cooldown (500ms) between completed commissioning attempts to prevent rapid reconnection. The cooldown timer starts when a commissioning connection is released (success or failure), not when it is accepted

**Rationale:** This model ensures:
- Resource usage is bounded and predictable (critical for 256KB MCUs)
- No wasted effort on commissioning that would fail with ZONE_FULL
- Operational connections are never blocked by commissioning activity
- Single commissioning connection minimizes attack surface

### 11.2 PASE Attempt Tracking

To mitigate brute force attacks while maintaining usability:

**Attempt Tracking:**

| Attempt Range | Delay Before Next | Rationale |
|---------------|-------------------|-----------|
| 1-3 | 0ms | Normal user mistakes |
| 4-6 | 1000ms | Possible attack |
| 7-10 | 3000ms | Likely attack |
| 11+ | 10000ms | Definite attack |

**Device Behavior:**
1. Device MUST track failed PASE attempts per commissioning window
2. Device MUST implement backoff delays as specified above
3. Attempt counter MUST reset when commissioning window closes
4. Attempt counter MUST reset on successful commissioning
5. Device SHOULD NOT reveal attempt count to controller

**Implementation Note:** Delay is applied before sending PASE response, not
after receiving request. This prevents timing analysis.

### 11.3 Certificate Renewal Nonce Binding

Certificate renewal requests MUST be bound to prevent replay attacks:

**Protocol Enhancement:**

The CertRenewalCSR message MUST include a nonce acknowledgment:

```cbor
CertRenewalCSR = {
  1: 31,                    ; MsgType
  2: <bytes[]>,             ; CSR (PKCS#10 DER)
  3: <bytes[16]>            ; NonceHash = SHA256(nonce)[0:16]
}
```

**Validation:**
1. Controller sends CertRenewalRequest with 32-byte nonce
2. Device stores nonce, generates key pair, creates CSR
3. Device includes NonceHash in CertRenewalCSR
4. Controller validates NonceHash matches sent nonce
5. If mismatch, controller SHOULD abort renewal

**New Error Code:**

| Code | Name | Description |
|------|------|-------------|
| 4 | RenewalStatusInvalidNonce | Nonce binding validation failed |

### 11.4 Generic Error Responses

To prevent information leakage about authentication progress:

**Error Code Consolidation:**

| Old Code | Old Name | New Code | New Name |
|----------|----------|----------|----------|
| 1 | ErrCodeInvalidPublicKey | 1 | ErrCodeAuthFailed |
| 2 | ErrCodeConfirmFailed | 1 | ErrCodeAuthFailed |

**Device Behavior:**
1. Device MUST return ErrCodeAuthFailed (1) for all authentication failures
2. Device SHOULD log detailed error information locally
3. Device MUST NOT vary response timing based on failure type

**Timing Requirement:**
- Device MUST add random delay (100-500ms) to all error responses
- This prevents timing-based oracle attacks

### 11.5 Overall Handshake Timeout

**Requirement:** Device MUST enforce maximum time for complete commissioning.

| Phase | Individual Timeout | Cumulative Max |
|-------|-------------------|----------------|
| TLS Handshake | 10s | 10s |
| First PASE Message | 5s (DEC-061) | 15s |
| PASE Exchange | 30s | 45s |
| CSR Generation | 10s | 55s |
| Cert Exchange | 30s | 85s |
| Cert Install | 5s | 90s |
| **Total** | - | **90s** |

**Device Behavior:**
1. Device MUST start the first-message timer when TLS connection accepted (DEC-061)
2. Device MUST start the overall handshake timer when first PASERequest is received (DEC-061)
3. If timer expires before CERT_ACK, device MUST close connection
4. Timer does not reset on message receipt
5. Individual phase timeouts still apply

### 11.6 Commissioning Window Duration (DEC-048)

Short commissioning windows reduce attack surface. See [Transport](transport.md) Section 12.

**Security Benefits:**

| Duration | Attack Window | Brute-Force Attempts |
|----------|---------------|---------------------|
| 3 hours (old) | Long | ~10,800 at 1/sec |
| 15 minutes (new) | Short | ~900 at 1/sec |

With PASE attempt tracking (Section 11.2), actual attempts are much lower due to
exponential backoff, but shorter windows still reduce total exposure.

**Window Duration Parameters:**

| Parameter | Value | Security Implication |
|-----------|-------|---------------------|
| Default | 15 minutes | Balances usability and security |
| Minimum | 3 minutes | Floor for any configuration |
| Maximum | 3 hours | Ceiling even for professional installers |

**Pairing Request Security:**

The `_mashp._udp` pairing request mechanism requires knowledge of the device
discriminator (12-bit value from QR code). This provides:

1. **Authorization:** Only users with physical access to QR code can re-trigger
2. **Rate limiting:** Device can track pairing request frequency
3. **Auditability:** Each re-trigger is a visible network event

**Device Requirements:**
1. Device MUST close commissioning window after successful commissioning
2. Device MUST close commissioning window after default duration expires
3. Device SHOULD allow pairing request to re-trigger window
4. Device SHOULD implement minimum interval between window re-triggers (60s)

### 11.7 Message-Gated Commissioning Locking (DEC-061)

The commissioning lock (single concurrent commissioning connection) MUST NOT be
acquired until the first valid PASERequest message arrives. This prevents idle
TLS connections from blocking commissioning.

**First-Message Timeout:**

| Parameter | Value | Description |
|-----------|-------|-------------|
| PASEFirstMessageTimeout | 5s | Max time from TLS accept to first PASE message |

**Device Behavior:**
1. Device MUST accept TLS commissioning connections without acquiring the commissioning lock
2. Device MUST wait for the first message after TLS handshake with a 5-second timeout
3. If timeout expires before a valid PASERequest arrives, device MUST close the connection silently (no lock was held, no error response)
4. Device MUST acquire the commissioning lock only after receiving a valid PASERequest
5. If the lock cannot be acquired (another PASE in progress), device MUST send `CommissioningError(DEVICE_BUSY)` with RetryAfter hint (Section 11.8) and close the connection
6. The overall handshake timer (Section 11.5) starts when PASERequest is received, not at TLS accept

**Connection Lifecycle:**

```
TLS Accept ─── WaitForPASERequest (5s, no lock) ─── Acquire Lock ─── CompleteHandshake (85s) ─── Cert Exchange ─── Release Lock ─── Start Cooldown
     │                    │                                │                                                              │
     │                    ├─ Timeout: close silently        ├─ Lock busy: send DEVICE_BUSY + RetryAfter, close             └─ PASE fail: release lock, start cooldown, close
     │                    └─ Invalid msg: close             └─ Cooldown active: send DEVICE_BUSY + RetryAfter, close
     │
     └─ TLS fail: close
```

The cooldown timer starts when a commissioning connection is **released** (success or failure),
not when it is accepted. This ensures that legitimate follow-up commissioning attempts are not
blocked by the cooldown of a still-in-progress connection.

**Rationale:**
- An idle TLS connection that never sends a PASERequest no longer holds the commissioning lock for 85 seconds
- Multiple TLS connections can be accepted simultaneously; only the first to send a valid PASERequest acquires the lock
- Aligns with Matter's approach of deferring resource commitment until the first application-layer message

### 11.8 Busy Rejection Response (DEC-063)

When a commissioning connection is rejected after PASERequest, the device MUST send
a `CommissioningError` message with error code 5 (`DEVICE_BUSY`) and a `RetryAfter`
hint before closing the connection. This replaces silent connection closure and gives
controllers actionable retry guidance.

**Error Code:**

| Code | Name | Description |
|------|------|-------------|
| 5 | ErrCodeBusy (DEVICE_BUSY) | Device cannot accept commissioning; retry later |

**CommissioningError Message Format (CBOR):**

```cbor
{
  1: 255,                    ; MsgType (CommissioningError)
  2: 5,                      ; ErrorCode (DEVICE_BUSY)
  3: "reason string",        ; Human-readable reason
  4: retryAfterMs            ; uint32, milliseconds (omitempty)
}
```

Key 4 (`RetryAfter`) uses `omitempty` -- it is not serialized when 0. This is
backward compatible: older implementations ignore unknown CBOR keys.

**RetryAfter Computation:**

| Condition | RetryAfter | Rationale |
|-----------|------------|-----------|
| Commissioning in progress | HandshakeTimeout ms | Wait for current handshake to complete |
| Cooldown period active | Remaining cooldown ms | Wait for cooldown to expire |
| All zone slots filled | 0 | No point retrying until decommission |

**Security Properties:**
1. Device MUST NOT reveal the specific reason for rejection beyond error code 5
2. The human-readable reason string is for diagnostics only, not machine-parseable
3. Device MUST NOT reveal current connection count or zone capacity
4. RetryAfter = 0 indicates the condition is permanent (no retry will help)

### 11.9 Stale Connection Reaper (DEC-064)

A device MUST implement a background reaper that periodically force-closes
pre-operational connections exceeding a staleness threshold. This is an anti-DoS
mechanism that catches connections which pass the transport-level cap (DEC-062)
but stall before becoming operational.

**Parameters:**

| Parameter | Default | Description |
|-----------|---------|-------------|
| StaleConnectionTimeout | 90s | Maximum age for pre-operational connections. Set 0 to disable. |
| ReaperInterval | 10s | How often the reaper scans for stale connections |

**Rules:**
1. Connections are tracked from TCP accept until they enter the operational message loop
2. Connections MUST be deregistered from the tracker before entering the operational message loop
3. The reaper MUST NOT close operational connections
4. The default timeout (90s) is intentionally greater than HandshakeTimeout (85s) -- per-phase timeouts fire first for well-behaved connections; the reaper is a safety net for edge cases
5. The reaper MUST exit cleanly when the service stops

**Defense-in-Depth Layers:**

| Layer | Mechanism | What It Catches |
|-------|-----------|-----------------|
| Transport cap (DEC-062) | Atomic counter at TCP accept | Excess connections before TLS |
| First-message timeout (DEC-061) | 5s timer after TLS | Idle TLS connections that never send PASE |
| Per-phase timeouts (11.5) | Individual phase limits | Slow/stalled handshake phases |
| **Stale reaper (DEC-064)** | **Periodic sweep** | **Any pre-operational connection that slips through other layers** |
| Busy response (DEC-063) | Error message after PASERequest | Rejected commissioning with retry guidance |

**Rationale:**
- The reaper is the last line of defense for connection resource exhaustion
- It handles edge cases where per-phase timeouts don't fire (e.g., connection accepted but handler goroutine delayed)
- The 90-second default ensures it never interferes with legitimate commissioning (85s max)
- Disabling via StaleConnectionTimeout=0 allows constrained deployments to opt out
